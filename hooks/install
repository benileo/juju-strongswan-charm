#!/usr/bin/env python3

from charmhelpers.core import hookenv
from strongswan.sysctl import cp_sysctl_file, configure_sysctl
from strongswan.iptables import configure_iptables
from strongswan.util import cp_hosts_file, flush_hosts_file
from strongswan.constants import CONFIG
from strongswan.errors import InvalidSourceError
from strongswan.archive import (
	install_strongswan_archives,
	install_strongswan_version,
	install_strongswan_upstream,
	install_pyOpenSSL
)



def pre_install():
	#exit(1)

	# first, setup IPtables for IPsec
	configure_iptables()

	# second, enable ip_forwarding
	cp_sysctl_file()		
	configure_sysctl()

	# make a copy of other important config files (for reference)
	cp_hosts_file()			
	
		

def install():
	source = CONFIG.get("source")

	# install strongswan from the archives #
	if source == 'archives':
		install_strongswan_archives()

	# install from the github account, most advanced. #
	elif source == 'upstream' :
		install_strongswan_upstream()

	# install strongswan from strongswan releases #
	else:
		install_strongswan_version( CONFIG.get("source") )	



def post_install():
	auth_method = CONFIG.get("auth_method")

	# install pyOPenSSL and dependencies if we are using x509s
	if ( auth_method == 'x509' or auth_method == 'rsa' ):
		try:
			from OpenSSL import crypto 
		except ImportError:
			install_pyOpenSSL()


		



# some cleanup
def cleanup():
	flush_hosts_file()



if __name__ == "__main__":
	pre_install()
	install()
	post_install()
	cleanup()