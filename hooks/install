#!/usr/bin/env python3

from charmhelpers.core import hookenv
import strongswan.iptables as iptables
from strongswan.constants import CONFIG
from strongswan.errors import InvalidSourceError
from strongswan.util import (
	cp_hosts_file, 
	flush_hosts_file, 
	cp_sysctl_file, 
	configure_sysctl
)
from strongswan.archive import (
	install_strongswan_archives,
	install_strongswan_version,
	install_strongswan_upstream,
	install_dep
)


def pre_install():
	"""
	@description:
	1. install dependencies 
	2. configure IPtables for IPsec 
	3. enable IP forwarding, make 
	4. copy sysctl.conf and hosts file for future reference
	"""
	install_dep()
	cp_hosts_file()
	cp_sysctl_file()
	iptables.filter()
	iptables.nat()
	iptables.save()
	configure_sysctl()

	
def install():
	"""
	@description: Install Strongswan in 1 of 3 ways.
	1. From the ubuntu archives
	2. From upstream github repo
	3. From stable strongswan releaes
	"""
	source = CONFIG.get("source")
	if source == 'archives':
		install_strongswan_archives()
	elif source == 'upstream' :
		install_strongswan_upstream()
	else:
		install_strongswan_version( CONFIG.get("source") )


def post_install():
	"""
	@description: Some post-install checks
	"""
	flush_hosts_file()



if __name__ == "__main__":
	pre_install()
	install()
	post_install()